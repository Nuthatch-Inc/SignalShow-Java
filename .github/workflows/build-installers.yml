name: Build Native Installers

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-mac:
    name: Build macOS Installer
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Java 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
      
      - name: Install JAI to local Maven repo
        run: |
          mvn install:install-file -Dfile=legacy-build/jai_core.jar \
            -DgroupId=javax.media.jai -DartifactId=jai-core \
            -Dversion=1.1.3 -Dpackaging=jar
          mvn install:install-file -Dfile=legacy-build/jai_codec.jar \
            -DgroupId=javax.media.jai -DartifactId=jai-codec \
            -Dversion=1.1.3 -Dpackaging=jar
      
      - name: Build macOS DMG
        run: |
          chmod +x build-installer-mac.sh
          ./build-installer-mac.sh
      
      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: SignalShow-macOS
          path: target/dist/*.dmg
          retention-days: 90

  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Java 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
      
      - name: Install WiX Toolset
        run: |
          choco install wixtoolset -y
          echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" >> $GITHUB_PATH
      
      - name: Install JAI to local Maven repo
        run: |
          mvn install:install-file -Dfile=legacy-build/jai_core.jar `
            -DgroupId=javax.media.jai -DartifactId=jai-core `
            -Dversion=1.1.3 -Dpackaging=jar
          mvn install:install-file -Dfile=legacy-build/jai_codec.jar `
            -DgroupId=javax.media.jai -DartifactId=jai-codec `
            -Dversion=1.1.3 -Dpackaging=jar
      
      - name: Build Windows Installer
        shell: bash
        run: |
          chmod +x build-installer-windows.sh
          ./build-installer-windows.sh
      
      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: SignalShow-Windows
          path: target/dist/SignalShow*
          retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [build-mac, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: SignalShow-macOS
          path: dist/
      
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: SignalShow-Windows
          path: dist/
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          draft: true
          generate_release_notes: true
          body: |
            ## SignalShow ${{ github.ref_name }}
            
            Educational signal and image processing application.
            
            ### Downloads
            
            - **macOS**: SignalShow-1.0.0.dmg
            - **Windows**: SignalShow-1.0.0.exe or .msi
            
            ### Installation
            
            **macOS:**
            1. Download and open the .dmg file
            2. Drag SignalShow to Applications folder
            3. Run from Applications
            
            **Windows:**
            1. Download and run the installer
            2. Follow installation wizard
            3. Run from Start Menu
            
            ### Requirements
            
            No Java installation required - bundled with the application.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
